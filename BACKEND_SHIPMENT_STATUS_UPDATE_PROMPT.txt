# Backend Implementation: Shipment Status Update Endpoints

## Overview
Implement two endpoints for updating shipment status in the Bookings collection. The frontend will automatically call the appropriate endpoint based on the number of selected bookings:
- **Single booking** (1 selected) → `PUT /api/bookings/:id/shipment-status`
- **Multiple bookings** (2+ selected) → `PUT /api/bookings/batch/shipment-status`

Both endpoints should update the `shipment_status` field in the Bookings collection and maintain a history of status changes.

---

## Database Schema

### Bookings Collection
Ensure the `bookings` collection has the following fields:

```javascript
{
  // ... existing booking fields ...
  
  shipment_status: {
    type: String,
    enum: [
      'SHIPMENT_RECEIVED',
      'SHIPMENT_PROCESSING',
      'DEPARTED_FROM_MANILA',
      'IN_TRANSIT_TO_DUBAI',
      'ARRIVED_AT_DUBAI',
      'SHIPMENT_CLEARANCE',
      'OUT_FOR_DELIVERY',
      'DELIVERED'
    ],
    default: null,
    index: true
  },
  
  batch_no: {
    type: String,
    default: null,
    index: true
  },
  
  shipment_status_history: [{
    status: String,
    updated_at: Date,
    updated_by: String,
    notes: String
  }],
  
  updatedAt: Date
}
```

---

## Endpoint 1: Single Booking Status Update

### PUT /api/bookings/:id/shipment-status

**Purpose**: Update the shipment status for a single booking.

**When Frontend Calls This**:
- User selects exactly 1 booking and clicks "Update Status"
- Frontend automatically calls this endpoint (not the batch endpoint)

**Request**:
- Method: `PUT`
- Headers: 
  - `Authorization: Bearer <token>`
  - `Content-Type: application/json`
- URL Parameters: 
  - `id` (string, required) - The booking ID
- Body:
```json
{
  "shipment_status": "SHIPMENT_PROCESSING",
  "updated_by": "employee_id_or_email",
  "notes": "Optional notes about the status update"
}
```

**Request Body Fields**:
- `shipment_status` (string, required) - Must be one of the valid status values
- `updated_by` (string, optional) - Employee ID or email of the user making the update
- `notes` (string, optional) - Additional notes about the status change

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "_id": "booking_id",
    "tracking_code": "PHWA116EUXY30XUYZ",
    "customer_name": "John Doe",
    "shipment_status": "SHIPMENT_PROCESSING",
    "batch_no": "BATCH-001",
    "shipment_status_history": [
      {
        "status": "SHIPMENT_RECEIVED",
        "updated_at": "2024-01-01T10:00:00.000Z",
        "updated_by": "employee_123",
        "notes": "Initial status"
      },
      {
        "status": "SHIPMENT_PROCESSING",
        "updated_at": "2024-01-01T12:00:00.000Z",
        "updated_by": "employee_123",
        "notes": "Processing started"
      }
    ],
    "updatedAt": "2024-01-01T12:00:00.000Z"
  }
}
```

**Implementation Logic**:
1. **Validate Request**:
   - Check if booking with `id` exists
   - Validate `shipment_status` is one of the allowed enum values
   - Validate user is authenticated (from Bearer token)

2. **Update Booking**:
   - Update `booking.shipment_status` with the new status
   - Update `booking.updatedAt` to current timestamp
   - Add entry to `booking.shipment_status_history` array:
     ```javascript
     {
       status: new_status,
       updated_at: new Date(),
       updated_by: updated_by || 'system',
       notes: notes || ''
     }
     ```

3. **Save and Return**:
   - Save the updated booking document
   - Return the updated booking with success response

**Error Responses**:

400 Bad Request - Invalid status value:
```json
{
  "success": false,
  "error": "Invalid shipment_status. Must be one of: SHIPMENT_RECEIVED, SHIPMENT_PROCESSING, DEPARTED_FROM_MANILA, IN_TRANSIT_TO_DUBAI, ARRIVED_AT_DUBAI, SHIPMENT_CLEARANCE, OUT_FOR_DELIVERY, DELIVERED"
}
```

404 Not Found - Booking not found:
```json
{
  "success": false,
  "error": "Booking not found"
}
```

401 Unauthorized - Missing or invalid token:
```json
{
  "success": false,
  "error": "Unauthorized. Please provide a valid authentication token."
}
```

**MongoDB/Mongoose Example**:
```javascript
// Express.js route handler example
router.put('/bookings/:id/shipment-status', authenticateToken, async (req, res) => {
  try {
    const { id } = req.params;
    const { shipment_status, updated_by, notes } = req.body;

    // Validate status
    const validStatuses = [
      'SHIPMENT_RECEIVED',
      'SHIPMENT_PROCESSING',
      'DEPARTED_FROM_MANILA',
      'IN_TRANSIT_TO_DUBAI',
      'ARRIVED_AT_DUBAI',
      'SHIPMENT_CLEARANCE',
      'OUT_FOR_DELIVERY',
      'DELIVERED'
    ];

    if (!validStatuses.includes(shipment_status)) {
      return res.status(400).json({
        success: false,
        error: `Invalid shipment_status. Must be one of: ${validStatuses.join(', ')}`
      });
    }

    // Find and update booking
    const booking = await Booking.findById(id);
    if (!booking) {
      return res.status(404).json({
        success: false,
        error: 'Booking not found'
      });
    }

    // Update status
    booking.shipment_status = shipment_status;
    booking.updatedAt = new Date();

    // Add to history
    booking.shipment_status_history.push({
      status: shipment_status,
      updated_at: new Date(),
      updated_by: updated_by || req.user?.email || 'system',
      notes: notes || ''
    });

    // Save
    await booking.save();

    return res.json({
      success: true,
      data: booking
    });
  } catch (error) {
    console.error('Error updating shipment status:', error);
    return res.status(500).json({
      success: false,
      error: 'Internal server error'
    });
  }
});
```

---

## Endpoint 2: Batch Status Update (Multiple Bookings)

### PUT /api/bookings/batch/shipment-status

**Purpose**: Update the shipment status for multiple bookings at once.

**When Frontend Calls This**:
- User selects 2 or more bookings and clicks "Update Status"
- Frontend automatically calls this endpoint (not the single endpoint)

**Request**:
- Method: `PUT`
- Headers: 
  - `Authorization: Bearer <token>`
  - `Content-Type: application/json`
- Body:
```json
{
  "booking_ids": ["booking_id_1", "booking_id_2", "booking_id_3"],
  "shipment_status": "IN_TRANSIT_TO_DUBAI",
  "batch_no": "BATCH-001",
  "updated_by": "employee_id_or_email",
  "notes": "Optional notes about the batch status update"
}
```

**Request Body Fields**:
- `booking_ids` (array of strings, required) - Array of booking IDs to update (minimum 2)
- `shipment_status` (string, required) - Must be one of the valid status values
- `batch_no` (string, optional) - Batch number to assign to all bookings
- `updated_by` (string, optional) - Employee ID or email of the user making the update
- `notes` (string, optional) - Additional notes about the status change

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "updated_count": 3,
    "bookings": [
      {
        "_id": "booking_id_1",
        "tracking_code": "PHWA116EUXY30XUYZ",
        "shipment_status": "IN_TRANSIT_TO_DUBAI",
        "batch_no": "BATCH-001",
        "updatedAt": "2024-01-01T12:00:00.000Z"
      },
      {
        "_id": "booking_id_2",
        "tracking_code": "PHWA117EUXY30XUYZ",
        "shipment_status": "IN_TRANSIT_TO_DUBAI",
        "batch_no": "BATCH-001",
        "updatedAt": "2024-01-01T12:00:00.000Z"
      },
      {
        "_id": "booking_id_3",
        "tracking_code": "PHWA118EUXY30XUYZ",
        "shipment_status": "IN_TRANSIT_TO_DUBAI",
        "batch_no": "BATCH-001",
        "updatedAt": "2024-01-01T12:00:00.000Z"
      }
    ]
  }
}
```

**Implementation Logic**:
1. **Validate Request**:
   - Validate `booking_ids` is an array with at least 2 items
   - Validate `shipment_status` is one of the allowed enum values
   - Validate user is authenticated

2. **Bulk Update Bookings**:
   - Find all bookings with IDs in `booking_ids` array
   - For each booking:
     - Update `booking.shipment_status` with the new status
     - If `batch_no` is provided, update `booking.batch_no`
     - Update `booking.updatedAt` to current timestamp
     - Add entry to `booking.shipment_status_history` array

3. **Use Bulk Operations** (for performance):
   - Use MongoDB `bulkWrite` or Mongoose `updateMany` for efficient updates
   - Or loop through and save each booking (if you need individual history entries)

4. **Return Results**:
   - Return count of updated bookings
   - Return array of updated booking documents

**Error Responses**:

400 Bad Request - Invalid request:
```json
{
  "success": false,
  "error": "booking_ids must be an array with at least 2 items"
}
```

400 Bad Request - Invalid status:
```json
{
  "success": false,
  "error": "Invalid shipment_status. Must be one of: SHIPMENT_RECEIVED, SHIPMENT_PROCESSING, ..."
}
```

404 Not Found - Some bookings not found:
```json
{
  "success": false,
  "error": "Some bookings not found. Found: 2, Requested: 3"
}
```

**MongoDB/Mongoose Example**:
```javascript
// Express.js route handler example
router.put('/bookings/batch/shipment-status', authenticateToken, async (req, res) => {
  try {
    const { booking_ids, shipment_status, batch_no, updated_by, notes } = req.body;

    // Validate booking_ids
    if (!Array.isArray(booking_ids) || booking_ids.length < 2) {
      return res.status(400).json({
        success: false,
        error: 'booking_ids must be an array with at least 2 items'
      });
    }

    // Validate status
    const validStatuses = [
      'SHIPMENT_RECEIVED',
      'SHIPMENT_PROCESSING',
      'DEPARTED_FROM_MANILA',
      'IN_TRANSIT_TO_DUBAI',
      'ARRIVED_AT_DUBAI',
      'SHIPMENT_CLEARANCE',
      'OUT_FOR_DELIVERY',
      'DELIVERED'
    ];

    if (!validStatuses.includes(shipment_status)) {
      return res.status(400).json({
        success: false,
        error: `Invalid shipment_status. Must be one of: ${validStatuses.join(', ')}`
      });
    }

    // Find all bookings
    const bookings = await Booking.find({ _id: { $in: booking_ids } });
    
    if (bookings.length !== booking_ids.length) {
      return res.status(404).json({
        success: false,
        error: `Some bookings not found. Found: ${bookings.length}, Requested: ${booking_ids.length}`
      });
    }

    // Update each booking
    const updatePromises = bookings.map(booking => {
      booking.shipment_status = shipment_status;
      if (batch_no) {
        booking.batch_no = batch_no;
      }
      booking.updatedAt = new Date();
      
      booking.shipment_status_history.push({
        status: shipment_status,
        updated_at: new Date(),
        updated_by: updated_by || req.user?.email || 'system',
        notes: notes || ''
      });
      
      return booking.save();
    });

    await Promise.all(updatePromises);

    return res.json({
      success: true,
      data: {
        updated_count: bookings.length,
        bookings: bookings
      }
    });
  } catch (error) {
    console.error('Error updating batch shipment status:', error);
    return res.status(500).json({
      success: false,
      error: 'Internal server error'
    });
  }
});
```

**Alternative: Using Bulk Write (More Efficient)**:
```javascript
// More efficient bulk update using MongoDB bulkWrite
const updateOps = booking_ids.map(bookingId => ({
  updateOne: {
    filter: { _id: bookingId },
    update: {
      $set: {
        shipment_status: shipment_status,
        ...(batch_no && { batch_no: batch_no }),
        updatedAt: new Date()
      },
      $push: {
        shipment_status_history: {
          status: shipment_status,
          updated_at: new Date(),
          updated_by: updated_by || req.user?.email || 'system',
          notes: notes || ''
        }
      }
    }
  }
}));

const result = await Booking.bulkWrite(updateOps);

// Fetch updated bookings to return
const updatedBookings = await Booking.find({ _id: { $in: booking_ids } });

return res.json({
  success: true,
  data: {
    updated_count: result.modifiedCount,
    bookings: updatedBookings
  }
});
```

---

## Valid Shipment Status Values

The following are the valid `shipment_status` values (in order of progression):

1. `SHIPMENT_RECEIVED` - Shipment Received
2. `SHIPMENT_PROCESSING` - Shipment Processing
3. `DEPARTED_FROM_MANILA` - Departed from Manila
4. `IN_TRANSIT_TO_DUBAI` - In Transit going to Dubai Airport
5. `ARRIVED_AT_DUBAI` - Arrived at Dubai Airport
6. `SHIPMENT_CLEARANCE` - Shipment Clearance
7. `OUT_FOR_DELIVERY` - Out for Delivery
8. `DELIVERED` - Delivered

---

## Security Requirements

1. **Authentication**: All endpoints require Bearer token authentication
2. **Authorization**: Consider restricting to specific departments (e.g., Operations, Auditor)
3. **Input Validation**: Validate all input fields
4. **Error Handling**: Return appropriate HTTP status codes and error messages
5. **Logging**: Log all status updates for audit trail

---

## Testing Checklist

- [ ] Single booking update with valid status
- [ ] Single booking update with invalid status (should return 400)
- [ ] Single booking update with non-existent booking ID (should return 404)
- [ ] Batch update with 2+ bookings
- [ ] Batch update with batch_no assignment
- [ ] Batch update with invalid booking_ids array (should return 400)
- [ ] Batch update with some non-existent booking IDs (should return 404)
- [ ] Verify shipment_status_history is updated correctly
- [ ] Verify updatedAt timestamp is updated
- [ ] Verify authentication is required
- [ ] Test with unauthorized user (should return 401)

---

## Notes

- The frontend automatically determines which endpoint to call based on selection count
- Both endpoints update the same `shipment_status` field in the Bookings collection
- The `shipment_status_history` array provides a complete audit trail
- The `batch_no` field can be updated during batch operations
- Consider adding database indexes on `shipment_status` and `batch_no` for better query performance

