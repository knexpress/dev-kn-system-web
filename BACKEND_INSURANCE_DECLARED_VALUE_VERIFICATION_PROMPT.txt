# Backend Implementation: Insurance and Declared Value in Operations Verification

## Overview
When the service is **UAE_TO_PINAS** (UAE_TO_PH) and the booking has `insured = true` with a `declared_value`, the Operations Verification form must allow users to view and edit the declared value. The backend must accept and store these values during verification updates.

## Requirements

### 1. Database Schema

#### Invoice Requests Collection
Ensure the `invoice_requests` collection (or `verification` subdocument) supports:

```javascript
{
  // ... existing fields ...
  
  verification: {
    // ... existing verification fields ...
    
    declared_value: {
      type: Number,
      default: null,
      min: 0
    },
    
    insured: {
      type: Boolean,
      default: false
    }
  }
}
```

#### Bookings Collection
The `bookings` collection should already have:
- `insured` (Boolean) - Whether the shipment is insured
- `declared_value` or `declaredAmount` (Number) - The declared value for insurance

---

## 2. API Endpoint: Update Verification

### PUT /api/invoice-requests/:id/verification

**Purpose**: Update verification details including declared value and insurance information.

**When Frontend Sends This**:
- Operations user completes verification form
- For UAE_TO_PINAS services with `insured = true`, frontend includes `declared_value` in the request

**Request**:
- Method: `PUT`
- Headers: 
  - `Authorization: Bearer <token>`
  - `Content-Type: application/json`
- URL Parameters: 
  - `id` (string, required) - The invoice request ID
- Body:
```json
{
  // ... existing verification fields ...
  
  "declared_value": 5000.00,
  "insured": true,
  
  // Other existing fields:
  "invoice_number": "INV-000050",
  "tracking_code": "PHWA116EUXY30XUYZ",
  "service_code": "UAE_TO_PH",
  "actual_weight": 25.5,
  "volumetric_weight": 30.2,
  "chargeable_weight": 30.2,
  "weight_type": "VOLUMETRIC",
  "shipment_classification": "FLOWMIC",
  "receiver_address": "123 Main St, Dubai",
  "receiver_phone": "+971501234567",
  "agents_name": "John Doe",
  "number_of_boxes": "5",
  "cargo_service": "Standard",
  "sender_details_complete": true,
  "receiver_details_complete": true,
  "verification_notes": "All details verified"
}
```

**Request Body Fields** (New/Updated):
- `declared_value` (number, optional) - Required when `insured = true` and service is `UAE_TO_PINAS`
- `insured` (boolean, optional) - Insurance status (should match booking data)

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "_id": "invoice_request_id",
    "verification": {
      "declared_value": 5000.00,
      "insured": true,
      "invoice_number": "INV-000050",
      "tracking_code": "PHWA116EUXY30XUYZ",
      "service_code": "UAE_TO_PH",
      "actual_weight": 25.5,
      "volumetric_weight": 30.2,
      "chargeable_weight": 30.2,
      "weight_type": "VOLUMETRIC",
      "shipment_classification": "FLOWMIC",
      // ... other verification fields
    },
    "updatedAt": "2024-01-01T12:00:00.000Z"
  }
}
```

**Implementation Logic**:
1. **Validate Request**:
   - Check if invoice request exists
   - Validate user is authenticated
   - If `insured = true` and service is `UAE_TO_PINAS`, ensure `declared_value` is provided and > 0

2. **Update Verification**:
   - Update `verification.declared_value` with the provided value
   - Update `verification.insured` with the provided value
   - Store other verification fields as usual
   - Update `updatedAt` timestamp

3. **Validation Rules**:
   - If `insured = true` and service code contains `UAE_TO_PH` or `UAE_TO_PINAS`:
     - `declared_value` must be provided
     - `declared_value` must be > 0
   - If `insured = false`, `declared_value` can be null or 0

**Error Responses**:

400 Bad Request - Missing declared value for insured shipment:
```json
{
  "success": false,
  "error": "declared_value is required when insured is true for UAE_TO_PINAS services"
}
```

400 Bad Request - Invalid declared value:
```json
{
  "success": false,
  "error": "declared_value must be a positive number"
}
```

**MongoDB/Mongoose Example**:
```javascript
// Express.js route handler example
router.put('/invoice-requests/:id/verification', authenticateToken, async (req, res) => {
  try {
    const { id } = req.params;
    const { declared_value, insured, ...otherVerificationFields } = req.body;

    // Find invoice request
    const invoiceRequest = await InvoiceRequest.findById(id);
    if (!invoiceRequest) {
      return res.status(404).json({
        success: false,
        error: 'Invoice request not found'
      });
    }

    // Get service code
    const serviceCode = otherVerificationFields.service_code || 
                       invoiceRequest.service_code || 
                       invoiceRequest.verification?.service_code || '';
    
    const isUaeToPinas = serviceCode.toUpperCase().includes('UAE_TO_PH') || 
                        serviceCode.toUpperCase().includes('UAE_TO_PINAS');

    // Validate insurance fields
    if (insured === true && isUaeToPinas) {
      if (!declared_value || declared_value <= 0) {
        return res.status(400).json({
          success: false,
          error: 'declared_value is required and must be greater than 0 when insured is true for UAE_TO_PINAS services'
        });
      }
    }

    // Update verification
    invoiceRequest.verification = {
      ...invoiceRequest.verification,
      ...otherVerificationFields,
      declared_value: declared_value || invoiceRequest.verification?.declared_value || null,
      insured: insured !== undefined ? insured : invoiceRequest.verification?.insured || false,
      updatedAt: new Date()
    };

    invoiceRequest.updatedAt = new Date();
    await invoiceRequest.save();

    return res.json({
      success: true,
      data: invoiceRequest
    });
  } catch (error) {
    console.error('Error updating verification:', error);
    return res.status(500).json({
      success: false,
      error: 'Internal server error'
    });
  }
});
```

---

## 3. Data Flow

### Frontend to Backend:
1. Operations user opens verification form
2. Frontend checks:
   - Service code = `UAE_TO_PINAS` (or `UAE_TO_PH`)
   - `insured = true` from booking/request
   - `declared_value` exists
3. If all conditions met, frontend displays:
   - Insurance status badge (read-only)
   - Declared value input field (editable)
   - Insurance charge calculation (1% of declared value)
4. User can edit declared value
5. On submit, frontend sends:
   - `declared_value` (number)
   - `insured` (boolean)
   - All other verification fields

### Backend Processing:
1. Receive verification update request
2. Validate `declared_value` if `insured = true` and service is `UAE_TO_PINAS`
3. Store `declared_value` and `insured` in verification document
4. Return updated invoice request

### Invoice Generation (Finance):
- Backend should use `verification.declared_value` to calculate insurance charge
- Insurance charge = `declared_value * 0.01` (1% of declared value)
- Include insurance charge in invoice line items

---

## 4. Insurance Charge Calculation

When generating invoices, the backend should:

1. Check if `verification.insured = true`
2. Check if `verification.declared_value` exists and > 0
3. Calculate insurance charge: `declared_value * 0.01`
4. Add insurance charge to invoice line items

**Example**:
```javascript
// In invoice generation logic
const insuranceCharge = (() => {
  if (invoiceRequest.verification?.insured === true && 
      invoiceRequest.verification?.declared_value > 0) {
    return invoiceRequest.verification.declared_value * 0.01; // 1% of declared value
  }
  return 0;
})();

// Add to invoice line items
lineItems.push({
  description: 'Insurance Charge',
  quantity: 1,
  unit_price: insuranceCharge,
  amount: insuranceCharge
});
```

---

## 5. Validation Rules Summary

| Condition | declared_value Required | Validation |
|-----------|------------------------|------------|
| `insured = true` AND `service = UAE_TO_PINAS` | ✅ Yes | Must be > 0 |
| `insured = false` | ❌ No | Can be null or 0 |
| `insured = true` AND `service = PH_TO_UAE` | ❌ No | Not applicable for this route |
| `insured = true` AND `service = other` | ❌ No | Only for UAE_TO_PINAS |

---

## 6. Testing Checklist

- [ ] Update verification with declared_value for UAE_TO_PINAS + insured = true
- [ ] Update verification without declared_value for UAE_TO_PINAS + insured = false
- [ ] Reject update if insured = true but declared_value is missing/0
- [ ] Reject update if declared_value is negative
- [ ] Verify declared_value is stored correctly in database
- [ ] Verify insurance charge is calculated correctly in invoice generation
- [ ] Test with different declared_value amounts
- [ ] Test with PH_TO_UAE service (should not require declared_value)
- [ ] Verify declared_value can be edited/updated in subsequent verifications

---

## 7. Notes

- The `declared_value` field should be stored as a Number (not String) in the database
- Consider using Decimal128 for precise currency calculations
- The insurance charge calculation (1% of declared value) should be consistent across the system
- The frontend displays the insurance charge preview: `declared_value * 0.01`
- The backend should use the same calculation when generating invoices
- If `declared_value` is updated during verification, the new value should be used for invoice generation

---

## 8. Related Endpoints

This change affects:
- `PUT /api/invoice-requests/:id/verification` - Update verification (add declared_value and insured)
- `POST /api/invoices-unified` - Invoice generation (use declared_value for insurance charge)
- `GET /api/invoice-requests/:id` - Return verification with declared_value and insured

---

## 9. Database Migration (if needed)

If the `verification` subdocument doesn't have `declared_value` and `insured` fields:

```javascript
// Migration script example
db.invoice_requests.updateMany(
  { "verification.declared_value": { $exists: false } },
  { $set: { "verification.declared_value": null } }
);

db.invoice_requests.updateMany(
  { "verification.insured": { $exists: false } },
  { $set: { "verification.insured": false } }
);
```

---

## 10. Security Considerations

1. Validate that only Operations department can update verification
2. Ensure `declared_value` is a valid number (not string, not negative)
3. Consider maximum limits for declared_value (if applicable)
4. Log all verification updates for audit trail
5. Validate that the invoice request status allows verification updates


