# Backend Implementation: Cargo Status Management System

## Overview
Implement a comprehensive cargo status management system that allows tracking shipment status for bookings that have verified invoices and generated invoices. The system should support individual and batch status updates, batch creation, and AWB-based search.

## Database Schema Changes

### Bookings Collection
Add the following fields to the `bookings` collection:

```javascript
{
  // ... existing fields ...
  
  shipment_status: {
    type: String,
    enum: [
      'SHIPMENT_RECEIVED',
      'SHIPMENT_PROCESSING',
      'DEPARTED_FROM_MANILA',
      'IN_TRANSIT_TO_DUBAI',
      'ARRIVED_AT_DUBAI',
      'SHIPMENT_CLEARANCE',
      'OUT_FOR_DELIVERY',
      'DELIVERED'
    ],
    default: null,
    index: true
  },
  
  batch_no: {
    type: String,
    default: null,
    index: true
  },
  
  shipment_status_history: [{
    status: String,
    updated_at: Date,
    updated_by: String,
    notes: String
  }]
}
```

## API Endpoints

### 1. GET /api/bookings/verified-invoices

**Purpose**: Get all bookings that have verified invoice requests and generated invoices.

**Request**:
- Method: GET
- Headers: Authorization Bearer token

**Response** (200 OK):
```json
{
  "success": true,
  "data": [
    {
      "_id": "booking_id",
      "tracking_code": "PHWA116EUXY30XUYZ",
      "awb_number": "PHWA116EUXY30XUYZ",
      "customer_name": "John Doe",
      "receiver_name": "Jane Smith",
      "origin_place": "Manila",
      "destination_place": "Dubai",
      "shipment_status": "SHIPMENT_RECEIVED",
      "batch_no": "BATCH-001",
      "invoice_id": "invoice_id",
      "invoice_number": "INV-000050",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

**Logic**:
1. Find all invoice requests with status = 'VERIFIED' or 'COMPLETED'
2. For each verified invoice request, find the associated booking (via `booking_id` or `request_id`)
3. Check if an invoice has been generated for that invoice request (check if invoice exists with `invoice_request_id` or `request_id`)
4. Return bookings that have both:
   - Invoice request status = 'VERIFIED' or 'COMPLETED'
   - Associated invoice exists in invoices collection
5. Populate invoice information (invoice_number, invoice_id)
6. Include shipment_status and batch_no from booking

**MongoDB Query Example**:
```javascript
// Pseudo-code
const verifiedInvoiceRequests = await InvoiceRequest.find({
  status: { $in: ['VERIFIED', 'COMPLETED'] }
});

const bookingIds = verifiedInvoiceRequests.map(req => req.booking_id || req.request_id);

const invoices = await Invoice.find({
  invoice_request_id: { $in: verifiedInvoiceRequests.map(r => r._id) }
});

const bookings = await Booking.find({
  _id: { $in: bookingIds },
  // Ensure invoice exists for this booking
}).populate('invoice_id');

// Filter to only include bookings with invoices
const bookingsWithInvoices = bookings.filter(booking => {
  return invoices.some(inv => 
    inv.invoice_request_id === booking.invoice_request_id ||
    inv.request_id === booking.request_id
  );
});
```

---

### 2. PUT /api/bookings/:id/shipment-status

**Purpose**: Update the shipment status for a single booking.

**Request**:
- Method: PUT
- Headers: Authorization Bearer token
- URL Parameters: `id` (booking ID)
- Body:
```json
{
  "shipment_status": "SHIPMENT_PROCESSING",
  "updated_by": "employee_id_or_email",
  "notes": "Optional notes about the status update"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "_id": "booking_id",
    "shipment_status": "SHIPMENT_PROCESSING",
    "batch_no": "BATCH-001",
    "shipment_status_history": [
      {
        "status": "SHIPMENT_PROCESSING",
        "updated_at": "2024-01-01T12:00:00.000Z",
        "updated_by": "employee_id",
        "notes": "Status updated"
      }
    ],
    "updatedAt": "2024-01-01T12:00:00.000Z"
  }
}
```

**Logic**:
1. Validate booking exists
2. Validate shipment_status is one of the allowed values
3. Update booking.shipment_status
4. Add entry to shipment_status_history array with:
   - status: new status
   - updated_at: current timestamp
   - updated_by: from request body
   - notes: from request body (optional)
5. Update booking.updatedAt
6. Return updated booking

**Validation**:
- shipment_status must be one of: 'SHIPMENT_RECEIVED', 'SHIPMENT_PROCESSING', 'DEPARTED_FROM_MANILA', 'IN_TRANSIT_TO_DUBAI', 'ARRIVED_AT_DUBAI', 'SHIPMENT_CLEARANCE', 'OUT_FOR_DELIVERY', 'DELIVERED'
- Booking must exist

---

### 3. PUT /api/bookings/batch/shipment-status

**Purpose**: Update shipment status for multiple bookings at once (batch update).

**Request**:
- Method: PUT
- Headers: Authorization Bearer token
- Body:
```json
{
  "booking_ids": ["booking_id_1", "booking_id_2", "booking_id_3"],
  "shipment_status": "IN_TRANSIT_TO_DUBAI",
  "batch_no": "BATCH-001",
  "updated_by": "employee_id_or_email",
  "notes": "Optional notes about the batch status update"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "updated_count": 3,
    "bookings": [
      {
        "_id": "booking_id_1",
        "shipment_status": "IN_TRANSIT_TO_DUBAI",
        "batch_no": "BATCH-001"
      },
      {
        "_id": "booking_id_2",
        "shipment_status": "IN_TRANSIT_TO_DUBAI",
        "batch_no": "BATCH-001"
      },
      {
        "_id": "booking_id_3",
        "shipment_status": "IN_TRANSIT_TO_DUBAI",
        "batch_no": "BATCH-001"
      }
    ]
  }
}
```

**Logic**:
1. Validate booking_ids array is not empty
2. Validate shipment_status is one of the allowed values
3. If batch_no is provided, update batch_no for all bookings
4. For each booking_id:
   - Update booking.shipment_status
   - Update booking.batch_no (if provided)
   - Add entry to shipment_status_history
5. Use bulk update for performance
6. Return count of updated bookings and updated booking data

**Validation**:
- booking_ids must be a non-empty array
- shipment_status must be valid
- All booking_ids must exist (or handle gracefully)

**MongoDB Bulk Update Example**:
```javascript
const updateOps = booking_ids.map(bookingId => ({
  updateOne: {
    filter: { _id: bookingId },
    update: {
      $set: {
        shipment_status: shipment_status,
        batch_no: batch_no || undefined,
        updatedAt: new Date()
      },
      $push: {
        shipment_status_history: {
          status: shipment_status,
          updated_at: new Date(),
          updated_by: updated_by,
          notes: notes || ''
        }
      }
    }
  }
}));

const result = await Booking.bulkWrite(updateOps);
```

---

### 4. POST /api/bookings/batch/create

**Purpose**: Create a batch and assign multiple bookings to it.

**Request**:
- Method: POST
- Headers: Authorization Bearer token
- Body:
```json
{
  "batch_no": "BATCH-001",
  "booking_ids": ["booking_id_1", "booking_id_2", "booking_id_3"],
  "created_by": "employee_id_or_email",
  "notes": "Optional notes about the batch"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "batch_no": "BATCH-001",
    "booking_count": 3,
    "bookings": [
      {
        "_id": "booking_id_1",
        "batch_no": "BATCH-001"
      },
      {
        "_id": "booking_id_2",
        "batch_no": "BATCH-001"
      },
      {
        "_id": "booking_id_3",
        "batch_no": "BATCH-001"
      }
    ]
  }
}
```

**Logic**:
1. Validate batch_no is provided and not empty
2. Validate booking_ids array is not empty
3. Check if batch_no already exists (optional: allow or prevent duplicates)
4. Update all bookings with the batch_no
5. Optionally create a Batch document/collection to track batches (if you want batch management)
6. Return batch information and updated bookings

**Validation**:
- batch_no must be provided and non-empty
- booking_ids must be a non-empty array
- All booking_ids must exist

**Optional: Batch Collection**
If you want to track batches separately, create a `batches` collection:
```javascript
{
  batch_no: String (unique, indexed),
  booking_ids: [ObjectId],
  created_by: String,
  created_at: Date,
  notes: String,
  status: String
}
```

---

### 5. GET /api/bookings/batch/:batchNo

**Purpose**: Get all bookings assigned to a specific batch number.

**Request**:
- Method: GET
- Headers: Authorization Bearer token
- URL Parameters: `batchNo` (batch number)

**Response** (200 OK):
```json
{
  "success": true,
  "data": [
    {
      "_id": "booking_id_1",
      "tracking_code": "PHWA116EUXY30XUYZ",
      "customer_name": "John Doe",
      "shipment_status": "IN_TRANSIT_TO_DUBAI",
      "batch_no": "BATCH-001"
    }
  ]
}
```

**Logic**:
1. Find all bookings where batch_no matches the provided batchNo
2. Return booking data

**MongoDB Query**:
```javascript
const bookings = await Booking.find({ batch_no: batchNo });
```

---

## Shipment Status Values

The following are the valid shipment status values (in order):

1. **SHIPMENT_RECEIVED** - Shipment Received
2. **SHIPMENT_PROCESSING** - Shipment Processing
3. **DEPARTED_FROM_MANILA** - Departed from Manila
4. **IN_TRANSIT_TO_DUBAI** - In Transit going to Dubai Airport
5. **ARRIVED_AT_DUBAI** - Arrived at Dubai Airport
6. **SHIPMENT_CLEARANCE** - Shipment Clearance
7. **OUT_FOR_DELIVERY** - Out for Delivery
8. **DELIVERED** - Delivered

## Status Progression Rules (Optional)

You may want to implement validation to ensure statuses progress in order:
- Status can only move forward (or stay the same)
- Or allow any status change (more flexible)

## Error Handling

All endpoints should handle:
- Invalid booking IDs (404 Not Found)
- Invalid shipment status values (400 Bad Request)
- Missing required fields (400 Bad Request)
- Database errors (500 Internal Server Error)
- Unauthorized access (401 Unauthorized)

**Error Response Format**:
```json
{
  "success": false,
  "error": "Error message here"
}
```

## Security

1. All endpoints require authentication (Bearer token)
2. Validate user permissions (e.g., only Operations/Auditor departments can update status)
3. Log all status updates for audit trail
4. Validate input data to prevent injection attacks

## Testing

Test cases to implement:
1. Get bookings with verified invoices - should only return bookings with invoices
2. Update single booking status - should update and add to history
3. Batch update status - should update all bookings
4. Create batch - should assign batch_no to all bookings
5. Get bookings by batch - should return all bookings in batch
6. Invalid status values - should return 400 error
7. Non-existent booking IDs - should handle gracefully
8. Empty arrays - should return 400 error

## Notes

- The shipment_status_history array provides an audit trail of all status changes
- batch_no can be updated when creating a batch or during batch status update
- Consider adding indexes on shipment_status and batch_no for better query performance
- The frontend expects bookings to have invoice_number and invoice_id populated

